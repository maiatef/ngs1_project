#1-Data Download:
wget -c ftp://ftp-trace.ncbi.nih.gov/sra/sra-instant/reads/ByRun/sra/SRR/SRR879/SRR8797509/SRR8797509.sra

#2-Convert the sra file to fastq
fastq-dump -I --split-files SRR879750.sra

#3-Prepare the data:
source activate ngs1
conda install -c bioconda seqkit
           
#For Unshuffled: Construct 5 Samples, each sample contains two parts
seqkit split2 -1 SRR8797509_1.fastq -2 SRR8797509_2.fastq -p 5 -s 1000000 -O out –f
 
#For Shuffled:
#Download the file from here:  
#https://ngscourse1.slack.com/archives/CGLTJSMQS/p1554753917030800

#Unzip it:
tar -xf shuffled_SRR8797509_1.part_001.tar.xz
tar -xf shuffled_SRR8797509_2.part_001.tar.xz

#Split the files (1M reads per file):
seqkit split2 -1 SRR8797509_1.part_001.fastq -2 SRR8797509_2.part_001.fastq -p 5 -s 1000000 -O out –f

#FASTQ Quality Control
source activate ngs1
conda install -c bioconda fastqc
conda install -c bioconda multiqc

#(ngs1) ngs-01@ngs01-VirtualBox:
~/workdir/Assignment/out$
fastqc -t 1 -f fastq -noextract shuffled_SRR8797509_1.part_001.part_001.fastq SRR8797509_1.part_001.fastq
fastqc -t 1 -f fastq -noextract shuffled_SRR8797509_1.part_001.part_002.fastq SRR8797509_1.part_002.fastq

#the unshuffled and the random shuffled data, didn't show any significant difference in their quality, they both showed the same gc-content 
#they both high phred score ~35 in the mean quality score and for sequence quality score.
#they showed 0% for the N-base content.
#2 samples had less than 1% of reads made up of overrepresented sequences
#No samples found with any adapter contamination > 0.1%

#5-Trimming
source activate ngs1	
conda install -c bioconda trimmomatic

#Mild Trimming for unshuffled reads:
f1="$HOME/workdir/Assignment/SRR8797509_1.pe.fastq"
f2="$HOME/workdir/Assignment/ SRR8797509_2.pe.fastq"
newf1="$HOME/workdir/Assignment/SRR8797509_1.pe.trim.fastq"
newf2="$HOME/workdir/Assignment/ SRR8797509_2.pe.trim.fastq"
newf1U="$HOME/workdir/Assignment/ SRR8797509_1.se.trim.fastq"
newf2U="$HOME/workdir/Assignment/ SRR8797509_2.se.trim.fastq"
adap="/home/ngs-01/miniconda3/envs/ngs1/share/trimmomatic-0.38-1/adapters"

trimmomatic PE -threads 1 -phred33 -trimlog trimLogFile -summary statsSummaryFile  $f1 $f2 $newf1 $newf1U $newf2 $newf2U \
ILLUMINACLIP:$adap/TruSeq3-PE.fa:2:30:10:1 SLIDINGWINDOW:4:15 MINLEN:36

#Aggressive Trimming for shuffled reads:
f1_sh="$HOME/workdir/Assignment/shuffled_SRR8797509_1.part_001.pe.fastq"
f2_sh="$HOME/workdir/Assignment/shuffled_SRR8797509_2.part_001.pe.fastq"
newf1_sh="$HOME/workdir/Assignment/shuffled_SRR8797509_1.part_001.pe.trim.fastq"
newf2_sh="$HOME/workdir/Assignment/shuffled_SRR8797509_2.part_001.pe.trim.fastq"
newf1U_sh="$HOME/workdir/Assignment/shuffled_SRR8797509_1.part_001.se.trim.fastq"
newf2U_sh="$HOME/workdir/Assignment/shuffled_SRR8797509_2.part_001.se.trim.fastq"
adap="/home/ngs-01/miniconda3/envs/ngs1/share/trimmomatic-0.38-1/adapters"

trimmomatic PE -threads 1 -phred33 -trimlog trimLogFile -summary statsSummaryFile  $f1_sh $f2_sh $newf1_sh $newf1U_sh $newf2_sh $newf2U_sh \
ILLUMINACLIP:$adap/TruSeq3-PE.fa:2:30:10:1 SLIDINGWINDOW:4:30 MINLEN:36

#1st trial !!
#6-Alignment
#Reference genome: Downloaded from https://www.gencodegenes.org/human/

gunzip GRCh38.p12.genome.fa.gz

#BWA Alignment:
conda install -c bioconda bwa
#index your genome:
~/workdir/Assignment$ mkdir -p bwa_align/bwaIndex && cd bwa_align/bwaIndex
~/workdir/Assignment/bwa_align/bwaIndex$ ln -s ~/workdir/Assignment/GRCh38.p12.genome.fa .
~/workdir/Assignment/bwa_align/bwaIndex$ bwa index -a bwtsw GRCh38.p12.genome.fa

#I repeated the previous steps several times and I keep on recieving this message!!
#[bwt_gen] Finished constructing BWT in 718 iterations.
#[bwa_index] 4359.69 seconds elapse.
#[bwa_index] Update BWT... [bwt_bwtupdate_core] Failed to allocate 3252208928 bytes at bwtindex.c line 158: Cannot allocate memory
#I said I will proceed to the next step and see the results.

#~/ workdir/Assignment/bwa_align 
/usr/bin/time -v bwa mem bwaIndex/GRCh38.p12.genome.fa $newf1 $newf2 > SRR8797509.sam

#I got an empty file ..the file SRR8797509.sam was created but it was empty, I have no idea is this because of the memory issue I have and
#The terminal keep on mentioning it or what is the problem....no clue!!

#2nd trials
#I increased the memory of the VM and repeated the indexing step and it finally worked l 7dl ..and i used the transcriptome reference
gunzip gencode.v30.annotation.gtf.gz
gunzip gencode.v30.transcripts.fa.gz
gunzip GRCh38.p12.genome.fa.gz

#BWA Alignment:
conda install -c bioconda bwa
~/workdir/Assignment$ mkdir -p bwa_align/bwaIndex && cd bwa_align/bwaIndex

#index your genome
~/workdir/Assignment/bwa_align/bwaIndex$ ln -s ~/workdir/Assignment/gencode.v30.transcripts.fa .
~/workdir/Assignment/bwa_align/bwaIndex$ bwa index -a bwtsw gencode.v30.transcripts.fa

#this step didn't work again ...an empty file is the output, i will try to check whether i entered the wrong files.
#i echoed the variables and they were not recognized
cd ~/ workdir/Assignment/bwa_align 
/usr/bin/time -v bwa mem bwaIndex/ gencode.v30.transcripts.fa $newf1U $newf2U > SRR8797509.sam


#I will try hisat2
# Indexing
#~/workdir/Assignment$ 
mkdir -p ~hisat_align/hisatIndex && cd ~hisat_align/hisatIndex
ln -s ~/workdir/Assignment/GRCh38.p12.genome.fa .
hisat2_extract_splice_sites.py ~/workdir/Assignment/gencode.v30.annotation.gtf > splicesites.tsv
hisat2_extract_exons.py ~/workdir/Assignment/gencode.v30.annotation.gtf > exons.tsv
hisat2-build -p 1 --ss splicesites.tsv --exon exons.tsv GRCh38.p12.genome.fa GRCh38.p12.genome

#A message popped out that I have low disk space, I can't increase it any more !!










